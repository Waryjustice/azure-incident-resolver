# GitHub Copilot Integration in Resolution Agent

## Overview
The Resolution Agent has been enhanced to integrate with GitHub Copilot for generating code fixes based on incident diagnoses. This enables the agent to create intelligent, contextual code solutions and automatically create GitHub PRs for permanent incident resolutions.

## New Features

### 1. GitHub Copilot Suggest Integration
The agent now uses the `gh copilot suggest` command to generate code fixes based on diagnosis data.

**Method:** `generate_fix_with_copilot(diagnosis, fix_type)`
- Takes incident diagnosis and fix type as input
- Prepares context with incident details, root cause, and requirements
- Calls GitHub Copilot CLI for code generation
- Falls back to placeholder implementations if Copilot is unavailable

### 2. Diagnosis-Based Context Preparation
**Method:** `_prepare_copilot_context(diagnosis, fix_type)`
- Extracts incident ID, root cause type, description, and affected component
- Formats context with specific requirements:
  - Proper error handling
  - Inline comments
  - Best practices
  - Backward compatibility

### 3. Copilot Command Execution
**Method:** `_call_copilot_suggest(context)`
- Executes `gh copilot suggest` command via subprocess
- Configurable timeout (30 seconds default)
- Graceful error handling for missing GitHub CLI
- Supports multiple suggestion types

### 4. Intelligent PR Creation
**Method:** `create_fix_pr(diagnosis, permanent_fix)`
- Creates GitHub branch from diagnosis incident ID
- Commits Copilot-generated code changes
- Creates descriptive PR with:
  - Incident ID and root cause details
  - Severity information
  - Files modified
  - Generated code diff
  - Labels: `incident-resolution`, `automated`, `{fix_type}`

**Method:** `_generate_pr_description(diagnosis, permanent_fix)`
- Generates detailed PR description with markdown formatting
- Includes incident timeline, root cause analysis, and fix details
- References that solution was generated by GitHub Copilot

## Supported Fix Types

1. **Connection Pooling** - Fixes database connection exhaustion
   - Target files: `src/database/connection.js`, `src/database/pool.js`

2. **Memory Leak** - Fixes memory leak issues
   - Target files: `src/services/cache.js`, `src/memory/manager.js`

3. **Backoff Retry** - Implements retry logic with backoff
   - Target files: `src/services/api-client.js`, `src/utils/retry.js`

## Prerequisites

1. **GitHub CLI installed**: `gh` command must be available in PATH
   ```bash
   brew install gh  # macOS
   choco install gh # Windows
   apt-get install gh # Linux
   ```

2. **GitHub Copilot CLI**: Requires GitHub Copilot subscription
   ```bash
   gh extension install github/gh-copilot
   ```

3. **Environment Variables**:
   - `GITHUB_TOKEN` - GitHub personal access token with repo permissions
   - `GITHUB_REPO_OWNER` - Repository owner
   - `GITHUB_REPO_NAME` - Repository name

## Usage Example

```python
# Initialize agent
agent = ResolutionAgent()

# Create a diagnosis (example)
diagnosis = {
    "incident_id": "INC-2024-001",
    "root_cause": {
        "type": "database_connection_exhaustion",
        "description": "Database connection pool exhausted due to slow queries"
    },
    "affected_component": "user-service",
    "severity": "high"
}

# Resolve incident with Copilot-generated fix
resolution = await agent.resolve_incident(diagnosis)

# Resolution will include:
# - immediate_fix: Scaling action
# - permanent_fix: Copilot-generated code fix
# - pr_url: GitHub PR with automated fix
```

## Error Handling

- **Missing `gh` command**: Falls back to placeholder implementation
- **Copilot timeout**: Returns placeholder implementation after 30 seconds
- **GitHub API errors**: Logs error and skips PR creation
- **PR creation failures**: Logs error but doesn't block incident resolution

## Workflow

```
Incident Diagnosis
    ↓
Determine Strategy
    ↓
Execute Immediate Fix (scaling, restart, etc.)
    ↓
Generate Permanent Fix with Copilot
    ├─ Prepare context with diagnosis data
    ├─ Call gh copilot suggest
    ├─ Parse generated code
    └─ Fallback to placeholder if unavailable
    ↓
Create GitHub PR
    ├─ Create fix branch
    ├─ Commit changes
    ├─ Create PR with description
    └─ Add labels
    ↓
Return Resolution Results
```

## Best Practices

1. **Provide Clear Diagnosis**: More detailed incident information leads to better Copilot suggestions
2. **Monitor Copilot Output**: Review generated PRs before merging
3. **Set Timeouts**: Adjust subprocess timeout based on network conditions
4. **GitHub CLI Authentication**: Ensure `gh auth` is properly configured
5. **PR Review**: Always have human review before merging auto-generated fixes

## Logging

The agent logs all Copilot interactions with the following prefixes:
- `[Resolution Agent] Requesting fix from GitHub Copilot...`
- `[Resolution Agent] Successfully generated fix with GitHub Copilot`
- `[Resolution Agent] Creating GitHub PR with Copilot-suggested fix...`
- `[Resolution Agent] [SUCCESS] PR created: {url}`

## Troubleshooting

| Issue | Solution |
|-------|----------|
| "gh command not found" | Install GitHub CLI |
| "Copilot suggest timed out" | Increase timeout value in `_call_copilot_suggest` |
| "PR creation failed" | Verify GITHUB_TOKEN and permissions |
| "No code generated" | Check GitHub CLI authentication and Copilot extension |

## Future Enhancements

- [ ] Support for code review automation
- [ ] Integration with GitHub Actions for auto-testing
- [ ] Multiple language support
- [ ] Custom fix type definitions
- [ ] Metrics collection for fix effectiveness
